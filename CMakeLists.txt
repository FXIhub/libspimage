PROJECT (spimage)


ADD_DEFINITIONS(-D H5_USE_16_API)

IF(WIN32)
	ADD_DEFINITIONS(-D_HDF5USEDLL_)
	ADD_DEFINITIONS(-D_CRT_SECURE_NO_DEPRECATE)
ELSE(WIN32)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -std=c99")
ENDIF(WIN32)
	

SET(BUILD_STATIC_LIB CACHE BOOL "If ON output static library. Otherwise output shared libraries.")
SET(DMALLOC_USE OFF CACHE BOOL "If ON link to dmalloc library if possible.")
SET(DOUBLE_PRECISION OFF CACHE BOOL "If ON use double precision. Otherwise use single precision")
SET(DEBUG_MEM OFF CACHE BOOL "If ON use memory debugging code.")

FIND_PATH (FFTW_INCLUDE_DIR fftw3.h PATHS ENV FFTW_INC NO_DEFAULT_PATH)
FIND_PATH (FFTW_INCLUDE_DIR fftw3.h PATHS /usr/include /sw/include)
FIND_PATH (PNG_INCLUDE_DIR png.h PATHS ENV PNG_INC NO_DEFAULT_PATH)
FIND_PATH (PNG_INCLUDE_DIR png.h PATHS /usr/include /sw/include ENV PNG_INC)
FIND_PATH (TIFF_INCLUDE_DIR tiff.h PATHS ENV TIFF_INC NO_DEFAULT_PATH)
FIND_PATH (TIFF_INCLUDE_DIR tiff.h PATHS /usr/include /sw/include)
FIND_PATH (HDF5_INCLUDE_DIR hdf5.h PATHS ENV HDF5_INC NO_DEFAULT_PATH)
FIND_PATH (HDF5_INCLUDE_DIR hdf5.h PATHS /usr/include /sw/include)

IF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)
	IF(EXISTS /usr/lib64)
		SET(LIBRARY_SUFFIX 64)
	ENDIF(EXISTS /usr/lib64)
ENDIF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)

FIND_LIBRARY (TIFF_LIBRARY tiff PATHS ENV TIFF_LIB NO_DEFAULT_PATH)
FIND_LIBRARY (TIFF_LIBRARY tiff PATHS /usr/lib /sw/lib)
FIND_LIBRARY (PNG_LIBRARY png PATHS ENV PNG_LIB NO_DEFAULT_PATH)
FIND_LIBRARY (PNG_LIBRARY png PATHS /usr/lib /sw/lib)
FIND_LIBRARY (HDF5_LIBRARY hdf5 PATHS ENV HDF5_LIB NO_DEFAULT_PATH)
FIND_LIBRARY (HDF5_LIBRARY hdf5 /usr/lib /sw/lib)
FIND_LIBRARY (MATH_LIBRARY m /usr/lib /sw/lib)
FIND_LIBRARY (C_LIBRARY c /usr/lib /sw/lib)
FIND_LIBRARY (Z_LIBRARY z /usr/lib /sw/lib)
FIND_LIBRARY (JPEG_LIBRARY jpeg PATHS ENV JPEG_LIB NO_DEFAULT_PATH)
FIND_LIBRARY (JPEG_LIBRARY jpeg PATHS /usr/lib /sw/lib)

IF(DOUBLE_PRECISION)
	ADD_DEFINITIONS(-D_SP_DOUBLE_PRECISION)
ELSE(DOUBLE_PRECISION)	
	ADD_DEFINITIONS(-D_SP_SINGLE_PRECISION)
ENDIF(DOUBLE_PRECISION)

IF(DEBUG_MEM)
	ADD_DEFINITIONS(-D_SP_DEBUG_MEM)
ENDIF(DEBUG_MEM)
	

IF(DMALLOC_USE)
		    FIND_LIBRARY (DMALLOC_LIBRARY dmalloc /usr/lib /sw/lib)
		    FIND_PATH (DMALLOC_INCLUDE_DIR dmalloc.h PATHS /usr/include /sw/include)	
		    IF(DMALLOC_LIBRARY)
		    		    ADD_DEFINITIONS(-D_USE_DMALLOC)
				    SET(LINK_TO_DMALLOC 1)
		    ENDIF(DMALLOC_LIBRARY)
ENDIF(DMALLOC_USE)



IF(WIN32)
FIND_LIBRARY (FFTW3_LIBRARY fftw3 PATHS ENV FFTW_LIB NO_DEFAULT_PATH)
FIND_LIBRARY (FFTW3_LIBRARY fftw3 /usr/lib /sw/lib)
ELSE(WIN32)

IF(DOUBLE_PRECISION)
	FIND_LIBRARY(FFTW3_LIBRARY fftw3 PATHS ENV FFTW_LIB NO_DEFAULT_PATH)
	FIND_LIBRARY(FFTW3_LIBRARY fftw3 PATHS /usr/lib /sw/lib)
	FIND_LIBRARY (FFTW3_THREADS_LIBRARY fftw3_threads PATHS ENV FFTW_LIB NO_DEFAULT_PATH)	
	FIND_LIBRARY (FFTW3_THREADS_LIBRARY fftw3_threads /usr/lib /sw/lib)	
ELSE(DOUBLE_PRECISION)
	FIND_LIBRARY(FFTW3F_LIBRARY fftw3f PATHS ENV FFTW_LIB NO_DEFAULT_PATH)
	FIND_LIBRARY(FFTW3F_LIBRARY fftw3f /usr/lib /sw/lib)
	FIND_LIBRARY (FFTW3F_THREADS_LIBRARY fftw3f_threads PATHS ENV FFTW_LIB NO_DEFAULT_PATH)	
	FIND_LIBRARY (FFTW3F_THREADS_LIBRARY fftw3f_threads /usr/lib /sw/lib)	
ENDIF(DOUBLE_PRECISION)

FIND_LIBRARY (PTHREAD_LIBRARY pthread /usr/lib /sw/lib)	
ENDIF(WIN32)
SET(FFTW_LIBRARY ${FFTW3_LIBRARY} ${FFTW3F_LIBRARY} ${FFTW3F_THREADS_LIBRARY} ${FFTW3_THREADS_LIBRARY} ${PTHREAD_LIBRARY})




INCLUDE_DIRECTORIES(${FFTW_INCLUDE_DIR} ${PNG_INCLUDE_DIR} ${TIFF_INCLUDE_DIR} ${HDF5_INCLUDE_DIR})


LIST(APPEND OBJECTS  "image_util.c" "fft.c" "linear_alg.c" "mem_util.c" "image_sphere.c" "sperror.c" "gaussianinv.c" "image_noise.c" "hashtable.c")



IF(BUILD_STATIC_LIB)
	ADD_LIBRARY(spimage STATIC ${OBJECTS})
ELSE(BUILD_STATIC_LIB)
	ADD_LIBRARY(spimage SHARED ${OBJECTS})
ENDIF(BUILD_STATIC_LIB)

ADD_EXECUTABLE(tests ${OBJECTS} CuTest.c AllTests.c ImageTests.c LinearTests.c ProjTests.c)


INSTALL(TARGETS spimage
  RUNTIME DESTINATION ${CMAKE_INSTALL_PREFIX}/bin
  LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib${LIBRARY_SUFFIX}
  ARCHIVE DESTINATION ${CMAKE_INSTALL_PREFIX}/lib${LIBRARY_SUFFIX})
INSTALL(FILES spimage/statistics.h spimage/image_noise.h spimage/fft.h spimage/image_util.h spimage/image.h spimage/linear_alg.h spimage/mem_util.h spimage/image_sphere.h spimage/sperror.h spimage/hashtable.h DESTINATION ${CMAKE_INSTALL_PREFIX}/include/spimage)
INSTALL(FILES spimage.h DESTINATION ${CMAKE_INSTALL_PREFIX}/include/)

LIST(APPEND TESTS_LIBRARIES  ${TIFF_LIBRARY} ${FFTW_LIBRARY} ${PNG_LIBRARY} ${HDF5_LIBRARY} ${MATH_LIBRARY} ${C_LIBRARY} ${Z_LIBRARY} ${JPEG_LIBRARY})
LIST(APPEND SPIMAGE_LIBRARIES  ${TIFF_LIBRARY} ${FFTW_LIBRARY} ${PNG_LIBRARY} ${HDF5_LIBRARY} ${MATH_LIBRARY} ${C_LIBRARY} ${Z_LIBRARY} ${JPEG_LIBRARY})
	    
IF(LINK_TO_DMALLOC)
LIST(APPEND SPIMAGE_LIBRARIES ${DMALLOC_LIBRARY})
LIST(APPEND TESTS_LIBRARIES ${DMALLOC_LIBRARY})
ENDIF(LINK_TO_DMALLOC)


TARGET_LINK_LIBRARIES(tests ${TESTS_LIBRARIES})
TARGET_LINK_LIBRARIES(spimage ${SPIMAGE_LIBRARIES})


ENABLE_TESTING()

ADD_TEST(tests tests)
