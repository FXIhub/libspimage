cmake_minimum_required(VERSION 2.6)

PROJECT (spimage)

SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")

ADD_DEFINITIONS(-D H5_USE_16_API)

IF(WIN32)
	ADD_DEFINITIONS(-D_HDF5USEDLL_)
	ADD_DEFINITIONS(-D_CRT_SECURE_NO_DEPRECATE)
ELSE(WIN32)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -std=c99")
ENDIF(WIN32)
	

SET(BUILD_STATIC_LIB CACHE BOOL "If ON output static library. Otherwise output shared libraries.")
SET(INCLUDE_DEPENDENCIES CACHE BOOL "[EXPERIMENTAL] If ON embed dependent libraries.")
SET(DMALLOC_USE OFF CACHE BOOL "If ON link to dmalloc library if possible.")
SET(DOUBLE_PRECISION OFF CACHE BOOL "If ON use double precision. Otherwise use single precision")
SET(DEBUG_MEM OFF CACHE BOOL "If ON use memory debugging code.")

find_package(TIFF REQUIRED)
find_package(FFTW3 REQUIRED)
find_package(PNG REQUIRED)
find_package(HDF5 REQUIRED)
find_package(JPEG REQUIRED)
find_package(ZLIB REQUIRED)
find_package(MATH REQUIRED)


IF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)
	IF(EXISTS /usr/lib64)
		SET(LIBRARY_SUFFIX 64)
	ENDIF(EXISTS /usr/lib64)
ENDIF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)


IF(DOUBLE_PRECISION)
	ADD_DEFINITIONS(-D_SP_DOUBLE_PRECISION)
ELSE(DOUBLE_PRECISION)	
	ADD_DEFINITIONS(-D_SP_SINGLE_PRECISION)
ENDIF(DOUBLE_PRECISION)

IF(DEBUG_MEM)
	ADD_DEFINITIONS(-D_SP_DEBUG_MEM)
ENDIF(DEBUG_MEM)
	

IF(DMALLOC_USE)
		    FIND_LIBRARY (DMALLOC_LIBRARY dmalloc /usr/lib /sw/lib)
		    FIND_PATH (DMALLOC_INCLUDE_DIR dmalloc.h PATHS /usr/include /sw/include)	
		    IF(DMALLOC_LIBRARY)
		    		    ADD_DEFINITIONS(-D_USE_DMALLOC)
				    SET(LINK_TO_DMALLOC 1)
		    ENDIF(DMALLOC_LIBRARY)
ENDIF(DMALLOC_USE)



INCLUDE_DIRECTORIES(${FFTW_INCLUDE_DIR} ${PNG_INCLUDE_DIR} ${TIFF_INCLUDE_DIR} ${HDF5_INCLUDE_DIR})
INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/include/")

IF(INCLUDE_DEPENDENCIES)
  IF(UNIX)
   SET(TIFF_LIBRARIES -static  ${TIFF_LIBRARIES} )
#    SET(TIFF_LIBRARIES -Wl,-Bstatic ${TIFF_LIBRARIES} -Wl,-Bdynamic)
#    SET(PNG_LIBRARIES -Wl,-Bstatic ${PNG_LIBRARIES} -Wl,-Bdynamic)
#    SET(ZLIB_LIBRARIES -Wl,-Bstatic ${ZLIB_LIBRARIES} -Wl,-Bdynamic)
#    SET(HDF5_LIBRARIES -Wl,-Bstatic ${HDF5_LIBRARIES} -Wl,-Bdynamic)
#    SET(JPEG_LIBRARIES -Wl,-Bstatic ${JPEG_LIBRARIES} -Wl,-Bdynamic)
    SET(JPEG_LIBRARIES ${JPEG_LIBRARIES} -Wl,-Bdynamic)
#    SET(FFTW3_LIBRARIES -Wl,-Bstatic ${FFTW3_LIBRARIES} -Wl,-Bdynamic)

  ENDIF(UNIX)
ENDIF(INCLUDE_DEPENDENCIES)


LIST(APPEND TESTS_LIBRARIES  ${TIFF_LIBRARIES} ${FFTW3_LIBRARIES} ${PNG_LIBRARIES} ${HDF5_LIBRARIES} ${MATH_LIBRARIES} ${ZLIB_LIBRARIES} ${JPEG_LIBRARIES})
LIST(APPEND SPIMAGE_LIBRARIES  ${TIFF_LIBRARIES} ${FFTW3_LIBRARIES} ${PNG_LIBRARIES} ${HDF5_LIBRARIES} ${MATH_LIBRARIES} ${ZLIB_LIBRARIES} ${JPEG_LIBRARIES})
	    
IF(LINK_TO_DMALLOC)
LIST(APPEND SPIMAGE_LIBRARIES ${DMALLOC_LIBRARY})
LIST(APPEND TESTS_LIBRARIES ${DMALLOC_LIBRARY})
ENDIF(LINK_TO_DMALLOC)

ADD_SUBDIRECTORY(src)
ADD_SUBDIRECTORY(include)
ADD_SUBDIRECTORY(tests)