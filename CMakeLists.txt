cmake_minimum_required(VERSION 2.6)

PROJECT (spimage)

SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")
SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/cuda")

ADD_DEFINITIONS(-D H5_USE_16_API)
# Make sure that while building this library the include files are not 
# built will export prefix
ADD_DEFINITIONS(-D SPIMAGE_NO_DLL)

IF(WIN32)
#	ADD_DEFINITIONS(-D_HDF5USEDLL_)
	ADD_DEFINITIONS(-D_CRT_SECURE_NO_DEPRECATE)
ENDIF(WIN32)

IF(CMAKE_COMPILER_IS_GNUCC)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -std=c99")
ENDIF(CMAKE_COMPILER_IS_GNUCC)

	

SET(BUILD_STATIC_LIB CACHE BOOL "If ON output static library. Otherwise output shared libraries.")
SET(INCLUDE_DEPENDENCIES CACHE BOOL "[EXPERIMENTAL] If ON embed dependent libraries.")
SET(DMALLOC_USE OFF CACHE BOOL "If ON link to dmalloc library if possible.")
SET(DOUBLE_PRECISION OFF CACHE BOOL "If ON use double precision. Otherwise use single precision")
SET(SP_MEM_DEBUG OFF CACHE BOOL "If ON use memory debugging code.")

find_package(TIFF REQUIRED)
find_package(FFTW3 REQUIRED)
find_package(PNG REQUIRED)
find_package(HDF5 REQUIRED)
find_package(JPEG REQUIRED)
find_package(ZLIB REQUIRED)
find_package(MATH REQUIRED)
find_package(GSL REQUIRED)
find_package(PythonLibs)
find_package(PythonInterp)
find_package(Numpy)
find_package(SWIG)
IF(CMAKE_VERSION)
# CMAKE VERSION was first defined in 2.6.3. Sorry for the hack
find_package(CUDA QUIET)
ELSE(CMAKE_VERSION)
message(STATUS "cmake 2.6.3 or higher required to use CUDA")
ENDIF(CMAKE_VERSION)


IF(CUDA_FOUND)
#set(CUDA_VERBOSE_BUILD ON)
ADD_DEFINITIONS(-D_USE_CUDA)
ENDIF(CUDA_FOUND)

IF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)
	IF(EXISTS /usr/lib64)
		SET(LIBRARY_SUFFIX 64)
	ENDIF(EXISTS /usr/lib64)
ENDIF(UNIX AND CMAKE_SIZEOF_VOID_P EQUAL 8)


IF(DOUBLE_PRECISION)
	ADD_DEFINITIONS(-D_SP_DOUBLE_PRECISION)
ELSE(DOUBLE_PRECISION)	
	ADD_DEFINITIONS(-D_SP_SINGLE_PRECISION)
ENDIF(DOUBLE_PRECISION)

IF(DEBUG_MEM)
	ADD_DEFINITIONS(-D_SP_DEBUG_MEM)
ENDIF(DEBUG_MEM)
	

IF(DMALLOC_USE)
		    FIND_LIBRARY (DMALLOC_LIBRARY dmalloc /usr/lib /sw/lib)
		    FIND_PATH (DMALLOC_INCLUDE_DIR dmalloc.h PATHS /usr/include /sw/include)	
		    IF(DMALLOC_LIBRARY)
		    		    ADD_DEFINITIONS(-D_USE_DMALLOC)
				    SET(LINK_TO_DMALLOC 1)
		    ENDIF(DMALLOC_LIBRARY)
ENDIF(DMALLOC_USE)



INCLUDE_DIRECTORIES(${FFTW3_INCLUDE_DIR} ${PNG_INCLUDE_DIR} ${TIFF_INCLUDE_DIR} ${HDF5_INCLUDE_DIR} ${MATH_INCLUDE_DIR} ${ZLIB_INCLUDE_DIR} ${JPEG_INCLUDE_DIR} ${GSL_INCLUDE_DIR})
INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/include/")
INCLUDE_DIRECTORIES("${CMAKE_SOURCE_DIR}/include/thrust")


LIST(APPEND TESTS_LIBRARIES  ${TIFF_LIBRARIES} ${FFTW3_LIBRARIES} ${PNG_LIBRARIES} ${HDF5_LIBRARIES} ${MATH_LIBRARIES} ${ZLIB_LIBRARIES} ${JPEG_LIBRARIES} ${GSL_LIBRARIES})
LIST(APPEND SPIMAGE_LIBRARIES  ${TIFF_LIBRARIES} ${FFTW3_LIBRARIES} ${PNG_LIBRARIES} ${HDF5_LIBRARIES} ${MATH_LIBRARIES} ${ZLIB_LIBRARIES} ${JPEG_LIBRARIES})
	    
IF(LINK_TO_DMALLOC)
LIST(APPEND SPIMAGE_LIBRARIES ${DMALLOC_LIBRARY})
LIST(APPEND TESTS_LIBRARIES ${DMALLOC_LIBRARY})
ENDIF(LINK_TO_DMALLOC)


ADD_SUBDIRECTORY(src)
ADD_SUBDIRECTORY(include)
ADD_SUBDIRECTORY(tests)
